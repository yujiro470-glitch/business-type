import os
from flask import Flask, render_template, request, session, redirect, url_for

# 質問リスト
all_questions = [
    {'id': 1, 'header': '複雑な問題について考えを整理する必要がある時、あなたは…', 'choice_a': '話しながらまとめる', 'trait_a': 'A', 'choice_b': '一人で考え抜く', 'trait_b': 'R'},
    {'id': 2, 'header': '長い一週間が終わり、心身をリフレッシュさせたい時、あなたは…', 'choice_a': '活気のある場に行く', 'trait_a': 'A', 'choice_b': '静かに過ごす', 'trait_b': 'R'},
    {'id': 3, 'header': '新しいプロジェクトのブレインストーミング会議で、あなたの役割は…', 'choice_a': '積極的に口火を切る', 'trait_a': 'A', 'choice_b': '慎重に発言する', 'trait_b': 'R'},
    {'id': 4, 'header': '未経験の分野について情報を集めるよう指示された時、あなたはまず…', 'choice_a': 'まず人と話す', 'trait_a': 'A', 'choice_b': 'まず自分で調べる', 'trait_b': 'R'},
    {'id': 5, 'header': 'あなたが最も「仕事が捗る」と感じる職場環境は…', 'choice_a': 'オープンで活気がある', 'trait_a': 'A', 'choice_b': '静かで集中できる', 'trait_b': 'R'},
    {'id': 6, 'header': '新しい企画の提案を聞く時、より心を動かされるのは…', 'choice_a': '未来の可能性や革新性', 'trait_a': 'C', 'choice_b': '現実的な成果や実用性', 'trait_b': 'D'},
    {'id': 7, 'header': '判断に迷う場面で、あなたが最終的に信頼を置くのは…', 'choice_a': '直感やひらめき', 'trait_a': 'C', 'choice_b': '事実や過去のデータ', 'trait_b': 'D'},
    {'id': 8, 'header': 'クライアントに何かを説明する時、あなたのスタイルは…', 'choice_a': '例え話や比喩を多用', 'trait_a': 'C', 'choice_b': '具体的な事例や数値を多用', 'trait_b': 'D'},
    {'id': 9, 'header': '前例のない問題が発生した時、価値を感じるのは…', 'choice_a': '斬新な方法を試す', 'trait_a': 'C', 'choice_b': '確実な方法を用いる', 'trait_b': 'D'},
    {'id': 10, 'header': 'プレゼン資料を作成する時、あなたがまず手をつけるのは…', 'choice_a': '長期的なビジョンから', 'trait_a': 'C', 'choice_b': '具体的な第一歩から', 'trait_b': 'D'},
    {'id': 11, 'header': 'チームの意見が二つに割れた時、あなたが目指すゴールは…', 'choice_a': '全員の納得感', 'trait_a': 'H', 'choice_b': '客観的な正しさ', 'trait_b': 'L'},
    {'id': 12, 'header': '後輩の明らかなミスを指摘しなければならない時、あなたは…', 'choice_a': '相手の気持ちを優先する', 'trait_a': 'H', 'choice_b': '率直に事実を伝える', 'trait_b': 'L'},
    {'id': 13, 'header': '社内ルールを適用する場面で、あなたの考えは…', 'choice_a': '状況に応じて柔軟に対応', 'trait_a': 'H', 'choice_b': '全員に一貫して適用', 'trait_b': 'L'},
    {'id': 14, 'header': '会議で自分の意見が少数派だとわかった時、あなたは…', 'choice_a': 'チームの和を保つため譲る', 'trait_a': 'H', 'choice_b': 'より良い結論のため議論する', 'trait_b': 'L'},
    {'id': 15, 'header': '人事評価で同僚を評価する際、より重視したいのは…', 'choice_a': '貢献意欲やプロセス', 'trait_a': 'H', 'choice_b': '実績や客観的な成果', 'trait_b': 'L'},
    {'id': 16, 'header': '新しいプロジェクトを任された時、心地よいと感じるのは…', 'choice_a': '詳細な計画を立てて完了させていく', 'trait_a': 'M', 'choice_b': '状況に応じて最適な手段を選ぶ', 'trait_b': 'X'},
    {'id': 17, 'header': '複数のタスクを抱えている時、あなたのスタンスは…', 'choice_a': '余裕をもって早めに終わらせる', 'trait_a': 'M', 'choice_b': '直前に集中して片付ける', 'trait_b': 'X'},
    {'id': 18, 'header': 'プロジェクトの進行中に、クライアントから急な方針変更を伝えられたら…', 'choice_a': '強いストレスを感じる', 'trait_a': 'M', 'choice_b': 'むしろ意欲が湧く', 'trait_b': 'X'},
    {'id': 19, 'header': '重要な意思決定を下す前の情報収集について、あなたは…', 'choice_a': 'すぐに確定させて次に進みたい', 'trait_a': 'M', 'choice_b': '直前まで情報を集め続けたい', 'trait_b': 'X'},
    {'id': 20, 'header': 'あなたのデスク周りやPCのデスクトップは、どのような状態ですか？', 'choice_a': '整理整頓された秩序ある環境', 'trait_a': 'M', 'choice_b': '流動的で自由な環境', 'trait_b': 'X'}
]

app = Flask(__name__)
# 秘密鍵を環境変数から読み込むように変更
app.secret_key = os.environ.get('SECRET_KEY', 'a-default-secret-key-for-local-use')

@app.route('/')
def index():
    # 診断開始時にスコアをリセットする
    session['scores'] = {'A': 0, 'R': 0, 'C': 0, 'D': 0, 'H': 0, 'L': 0, 'M': 0, 'X': 0}
    return render_template('index.html')

@app.route('/quiz')
def quiz():
    # 全質問をquiz.htmlに渡す
    return render_template('quiz.html', questions=all_questions)

@app.route('/result', methods=['POST'])
def result():
    scores = {'A': 0, 'R': 0, 'C': 0, 'D': 0, 'H': 0, 'L': 0, 'M': 0, 'X': 0}
    
    for question in all_questions:
        answer_str = request.form.get(f"answer-{question['id']}", '4')
        answer = int(answer_str)
        
        trait_a = question['trait_a']
        trait_b = question['trait_b']

        if answer <= 3:
            score = 4 - answer
            scores[trait_a] += score
        elif answer >= 5:
            score = answer - 4
            scores[trait_b] += score
    
    type1 = 'A' if scores.get('A', 0) >= scores.get('R', 0) else 'R'
    type2 = 'C' if scores.get('C', 0) >= scores.get('D', 0) else 'D'
    type3 = 'H' if scores.get('H', 0) >= scores.get('L', 0) else 'L'
    type4 = 'M' if scores.get('M', 0) >= scores.get('X', 0) else 'X'
    final_type = type1 + type2 + type3 + type4
    
    type_descriptions = {
        "ACHM": {"name": "夢見るリーダー", "summary": "壮大なビジョンを語り、チームに寄り添いながら計画的に導くリーダー。人を巻き込み、アイデアを着実に形にする。", "strength": "ビジョンで人を惹きつける力。共感と計画性で円滑なチームを作る。プロジェクトの推進力。", "weakness": "理想や調和を優先し、厳しい決断を先延ばしにしがち。細かい分析や地道な作業は苦手。"},
        "ACHX": {"name": "ひらめきの仕掛人", "summary": "人との対話から次々と新しいアイデアを生み出すムードメーカー。変化を楽しみ、柔軟に人を巻き込む。", "strength": "場を盛り上げる発想力。変化への適応力と対人スキル。トレンドを掴むのが得意。", "weakness": "アイデアが広がりすぎて、物事を最後までやり遂げるのが苦手なことも。計画的な行動は窮屈に感じる。"},
        "ACLM": {"name": "改革の実行者", "summary": "未来を見据え、論理的な戦略で大胆な改革を断行するリーダー。目標達成のため、情に流されず組織を動かす。", "strength": "本質を見抜く戦略的思考。目標達成への強い意志と実行力。困難な状況でも合理的に判断できる。", "weakness": "正論で人を動かそうとし、反発を招くことがある。人の感情への配慮が不足しがち。"},
        "ACLX": {"name": "革新のチャレンジャー", "summary": "常識にとらわれず、新しい価値を創造する挑戦者。論理と柔軟性を武器に、リスクを恐れず行動する。", "strength": "ゼロから１を生み出す発想力。知的な議論を恐れない探求心。前例のない問題への適応力。", "weakness": "組織のルールを軽視し、周囲と衝突しがち。興味が移りやすく、物事の維持管理は苦手。"},
        "ADHM": {"name": "チームの支え役", "summary": "現場の事実に基づき、メンバーに気を配りながら着実にチームをまとめる。日々の対話を大切にする。", "strength": "安定した組織運営と部下の育成。地に足のついた目標達成力。円滑な人間関係を築く力。", "weakness": "前例を重んじ、大きな変化には抵抗を感じがち。「情」に流され、非情な決断が苦手。"},
        "ADHX": {"name": "頼れる火消し役", "summary": "予期せぬ問題が起きても、現場の状況を即座に把握し、現実的な解決策を実行する行動派。", "strength": "抜群の現場対応力と危機管理能力。フットワークの軽さと交渉・調整力。", "weakness": "長期的な計画を立てるのは苦手。目の前の問題解決に集中し、根本原因を見過ごすことも。"},
        "ADLM": {"name": "効率化の鬼", "summary": "データと事実に基づき、最も効率的な方法を追求する結果至上主義者。無駄をなくし、生産性を最大化する。", "strength": "業務プロセスの改善力。データに基づく客観的な意思決定。タスクを効率的にこなす管理能力。", "weakness": "効率を追求するあまり、人の気持ちを軽視しがち。ルールに厳格で、融通が利かない面も。"},
        "ADLX": {"name": "即断即決の実践家", "summary": "目の前の課題を素早く分析し、最短の解決策を即座に実行する実践家。状況の変化にも柔軟に対応する。", "strength": "卓越した問題解決能力と迅速な意思決定。プレッシャーに強く、実践的な知識が豊富。", "weakness": "短期的な視点に陥り、長期的な影響を見過ごすことがある。単独行動を好み、情報共有を怠ることも。"},
        "RCHM": {"name": "献身的な理想家", "summary": "内なるビジョンや信念を、静かに、しかし着実に形にしようとする。人々のためになる理想を粘り強く追求する。", "strength": "強い信念と一貫性のある行動。深い洞察力で人の可能性を育む。決めたことを最後までやり遂げる誠実さ。", "weakness": "理想に固執し、現実とのギャップに苦しむことがある。自己表現が控えめで、理解されにくいことも。"},
        "RCHX": {"name": "発想の探求者", "summary": "知的好奇心の赴くままに、様々な概念や理論の世界を探検する。複数のアイデアを柔軟に結びつけ、可能性を示す。", "strength": "既成概念にとらわれず独創的な発想力。物事の裏にある意味を見出す洞察力。人の心に響く共感力。", "weakness": "アイデアを現実に落とし込むのが苦手。ルールや締め切りに縛られることを嫌う。"},
        "RCLM": {"name": "静かなる戦略家", "summary": "複雑な世界の法則を解明し、完璧な理論体系を構築する思想家。一人で深く思考し、長期的な計画を設計する。", "strength": "高度な戦略的思考と体系的な理解力。独立心が強く、やり遂げる意志が固い。長期的な未来を見通す力。", "weakness": "自分の考えが正しいと信じ、他者の意見を聞き入れないことがある。人の感情の機微を軽視しがち。"},
        "RCLX": {"name": "知の探求者", "summary": "あらゆる可能性を検討し、知的な挑戦を楽しむ生粋の探求者。複雑な問題を多角的に分析し、最適な解を探し続ける。", "strength": "高度な分析能力と問題解決能力。旺盛な知的好奇心。物事を客観的に捉え、的確な批評ができる。", "weakness": "思考に深く潜り、行動が遅れがち。ロジックの穴を鋭く指摘し、意図せず人を傷つけることがある。"},
        "RDHM": {"name": "縁の下の支援者", "summary": "組織の安定と人々の幸せを願い、縁の下で黙々と貢献する。事実に基づき、責任感を持って役割を全うする。", "strength": "高い忠誠心と責任感。丁寧でミスのない仕事ぶり。困っている人を助ける献身的な心。", "weakness": "変化を嫌い、新しいやり方を受け入れるのに時間がかかる。自己評価が低く、功績をアピールできない。"},
        "RDHX": {"name": "我が道を行く職人", "summary": "自分のペースで、好きな分野のスキルや知識を黙々と探求する。現実的なツールを使いこなし、好奇心に従う。", "strength": "特定分野での深い知識と実践的スキル。マイペースで精神的に安定。より良い方法を臨機応変に見つける力。", "weakness": "集団行動や厳格なルールは苦手。コミュニケーションが不器用で、何を考えているか分かりにくい面も。"},
        "RDLM": {"name": "信頼のスペシャリスト", "summary": "事実とデータを徹底的に精査し、専門性を追求する権威。論理と秩序に基づき、正確で信頼性の高い仕事をこなす。", "strength": "専門分野での極めて深い知識と正確性。高い自己管理能力。一度引き受けたことを完璧にやり遂げる。", "weakness": "専門外のことや人の感情には関心が薄い。他者にも自分と同じレベルの正確さや規律を求め、厳しく評価しがち。"},
        "RDLX": {"name": "冷静な分析家", "summary": "感情に左右されず、客観的な事実と論理だけを頼りに物事の本質を分析する。状況の変化にも冷静に対応する。", "strength": "高い分析能力と客観的な観察眼。緊急時でも冷静に対応できる。新しい事実に合わせて柔軟に結論を修正できる。", "weakness": "他者への共感や関心が薄く、「人間味がない」と見られることがある。分析に時間をかけすぎ、意思決定が遅れることも。"}
    }
    
    details = type_descriptions.get(final_type, {})

    return render_template(
        'result.html',
        final_type=final_type,
        details=details
    )

@app.route('/privacy')
def privacy():
    return render_template('privacy.html')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)